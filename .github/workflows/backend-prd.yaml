name: backend-prd-CICD

on:
  push:
    branches:
      - "production"
    paths-ignore:
      - "backend/cicd/prd/charts/override_values.yaml"

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    env:
      dockerimage_tag: ${{ github.sha }}
      dockerimage_name: choisunguk/ciat-prd-backend:${{ github.sha }}

    # 1. git submoduleì„ ì´ìš©í•´ì„œ ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œíŒŒì¼ ë³µì‚¬
    # 2. ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
    # 3. docker build
    # 4. docker push
    steps:
    - uses: actions/checkout@v2
      with:
        ssh-key: ${{ secrets.GITHUBACTION_KEY }}
        submodules: 'recursive'
        
    - name: copy springboot profile
      run: |
        cp ./src/main/resources/CIAT_private/springboot/application-prd.yaml ./src/main/resources/application-prd.yaml 
      
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
        server-id: github
        settings-path: ${{ github.workspace }}
    
    - name: gradle build
      run: |
        gradle clean build --exclude-task test

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: copy dockerfile
      run: |
        rm -rf ./Dockerfile
        cp ./cicd/prd/Dockerfile ./Dockerfile

    - name: Build and push
      id: docker_build
      run: |
        docker build -t ${{ env.dockerimage_name }} .
        docker push ${{ env.dockerimage_name }}

    - name: change override_values.yaml
      run: |
        cat <<EOF > ./cicd/prd/charts/override_values.yaml
        image:
          tag: ${{ env.dockerimage_tag }}
        EOF

    - name: git push
      run: |
        git config --global user.email "GitHub Actions Bot@github.com"
        git config --global user.name "GitHub Actions Bot"
        git add ./cicd/prd/charts/override_values.yaml
        git commit -m "change dockertag"
        git push origin production
    
    # - name: Discord Alert Success
    #   uses: sarisia/actions-status-discord@v1
    #   if: success()
    #   with:
    #       webhook: ${{ secrets.DISCORD_WEBHOOK }}
    #       description: "ğŸ‰ í…ŒìŠ¤íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤!"

    # - name: Discord Alert Failure
    #   uses: sarisia/actions-status-discord@v1
    #   if: failure()
    #   with:
    #       webhook: ${{ secrets.DISCORD_WEBHOOK }}
    #       description: "ğŸ”¥ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤."

    - name: Publish Unit Test Results
      uses: EnricoMi/publish-unit-test-result-action@v1
      if: ${{ always() }}
      with:
          files: build/test-results/*/.xml

    - name: Cleanup Gradle Cache
        # Remove some files from the Gradle cache, so they aren't cached by GitHub Actions.
        # Restoring these files from a GitHub Actions cache might cause problems for future builds.
      if: ${{ always() }}
      run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties
  